"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_appmesh_1 = require("@aws-cdk/aws-appmesh");
const aws_ecs_1 = require("@aws-cdk/aws-ecs");
const core_1 = require("@aws-cdk/core");
const lib_1 = require("../lib");
const app = new core_1.App();
const stack = new core_1.Stack(app, 'aws-ecs-integ');
const mesh = new aws_appmesh_1.Mesh(stack, 'my-mesh');
const environment = new lib_1.Environment(stack, 'production');
/** Name service */
const nameDescription = new lib_1.ServiceDescription();
nameDescription.add(new lib_1.Container({
    cpu: 1024,
    memoryMiB: 2048,
    trafficPort: 80,
    image: aws_ecs_1.ContainerImage.fromRegistry('nathanpeck/name'),
    environment: {
        PORT: '80',
    },
}));
nameDescription.add(new lib_1.AppMeshExtension({ mesh }));
nameDescription.add(new lib_1.FireLensExtension());
nameDescription.add(new lib_1.XRayExtension());
nameDescription.add(new lib_1.CloudwatchAgentExtension());
nameDescription.add(new lib_1.ScaleOnCpuUtilization({
    initialTaskCount: 2,
    minTaskCount: 2,
}));
const nameService = new lib_1.Service(stack, 'name', {
    environment: environment,
    serviceDescription: nameDescription,
});
/** Greeting service */
const greetingDescription = new lib_1.ServiceDescription();
greetingDescription.add(new lib_1.Container({
    cpu: 1024,
    memoryMiB: 2048,
    trafficPort: 80,
    image: aws_ecs_1.ContainerImage.fromRegistry('nathanpeck/greeting'),
    environment: {
        PORT: '80',
    },
}));
greetingDescription.add(new lib_1.AppMeshExtension({ mesh }));
greetingDescription.add(new lib_1.FireLensExtension());
greetingDescription.add(new lib_1.XRayExtension());
greetingDescription.add(new lib_1.CloudwatchAgentExtension());
greetingDescription.add(new lib_1.ScaleOnCpuUtilization({
    initialTaskCount: 2,
    minTaskCount: 2,
}));
const greetingService = new lib_1.Service(stack, 'greeting', {
    environment: environment,
    serviceDescription: greetingDescription,
});
/** Greeter service */
const greeterDescription = new lib_1.ServiceDescription();
greeterDescription.add(new lib_1.Container({
    cpu: 1024,
    memoryMiB: 2048,
    trafficPort: 80,
    image: aws_ecs_1.ContainerImage.fromRegistry('nathanpeck/greeter'),
    environment: {
        PORT: '80',
        GREETING_URL: 'http://greeting.production',
        NAME_URL: 'http://name.production',
    },
}));
greeterDescription.add(new lib_1.AppMeshExtension({ mesh }));
greeterDescription.add(new lib_1.FireLensExtension());
greeterDescription.add(new lib_1.XRayExtension());
greeterDescription.add(new lib_1.CloudwatchAgentExtension());
greeterDescription.add(new lib_1.HttpLoadBalancerExtension());
greeterDescription.add(new lib_1.ScaleOnCpuUtilization({
    initialTaskCount: 2,
    minTaskCount: 2,
}));
const greeterService = new lib_1.Service(stack, 'greeter', {
    environment: environment,
    serviceDescription: greeterDescription,
});
greeterService.connectTo(nameService);
greeterService.connectTo(greetingService);
/**
 * Expectations are that you should see an output
 * of the load balancer URL for the greeter service, make
 * a request to it and see a greeting phrase constructed out
 * of a random greeting and a random name from the two underlying
 * services. The other addons enable tracing and logging which must
 * be verified separately.
 */ 
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcuYWxsLXNlcnZpY2UtYWRkb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW50ZWcuYWxsLXNlcnZpY2UtYWRkb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0RBQTRDO0FBQzVDLDhDQUFrRDtBQUNsRCx3Q0FBMkM7QUFDM0MsZ0NBQTZNO0FBRTdNLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7QUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBRTlDLE1BQU0sSUFBSSxHQUFHLElBQUksa0JBQUksQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDeEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBVyxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztBQUV6RCxtQkFBbUI7QUFDbkIsTUFBTSxlQUFlLEdBQUcsSUFBSSx3QkFBa0IsRUFBRSxDQUFDO0FBQ2pELGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxlQUFTLENBQUM7SUFDaEMsR0FBRyxFQUFFLElBQUk7SUFDVCxTQUFTLEVBQUUsSUFBSTtJQUNmLFdBQVcsRUFBRSxFQUFFO0lBQ2YsS0FBSyxFQUFFLHdCQUFjLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDO0lBQ3JELFdBQVcsRUFBRTtRQUNYLElBQUksRUFBRSxJQUFJO0tBQ1g7Q0FDRixDQUFDLENBQUMsQ0FBQztBQUNKLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxzQkFBZ0IsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNwRCxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksdUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0FBQzdDLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxtQkFBYSxFQUFFLENBQUMsQ0FBQztBQUN6QyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksOEJBQXdCLEVBQUUsQ0FB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O0FBRUgsY0FBYyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN0QyxjQUFjLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBRTFDOzs7Ozs7O0dBT0ciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXNoIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWFwcG1lc2gnO1xuaW1wb3J0IHsgQ29udGFpbmVySW1hZ2UgfSBmcm9tICdAYXdzLWNkay9hd3MtZWNzJztcbmltcG9ydCB7IEFwcCwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IEFwcE1lc2hFeHRlbnNpb24sIENsb3Vkd2F0Y2hBZ2VudEV4dGVuc2lvbiwgQ29udGFpbmVyLCBFbnZpcm9ubWVudCwgRmlyZUxlbnNFeHRlbnNpb24sIEh0dHBMb2FkQmFsYW5jZXJFeHRlbnNpb24sIFNjYWxlT25DcHVVdGlsaXphdGlvbiwgU2VydmljZSwgU2VydmljZURlc2NyaXB0aW9uLCBYUmF5RXh0ZW5zaW9uIH0gZnJvbSAnLi4vbGliJztcblxuY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnYXdzLWVjcy1pbnRlZycpO1xuXG5jb25zdCBtZXNoID0gbmV3IE1lc2goc3RhY2ssICdteS1tZXNoJyk7XG5jb25zdCBlbnZpcm9ubWVudCA9IG5ldyBFbnZpcm9ubWVudChzdGFjaywgJ3Byb2R1Y3Rpb24nKTtcblxuLyoqIE5hbWUgc2VydmljZSAqL1xuY29uc3QgbmFtZURlc2NyaXB0aW9uID0gbmV3IFNlcnZpY2VEZXNjcmlwdGlvbigpO1xubmFtZURlc2NyaXB0aW9uLmFkZChuZXcgQ29udGFpbmVyKHtcbiAgY3B1OiAxMDI0LFxuICBtZW1vcnlNaUI6IDIwNDgsXG4gIHRyYWZmaWNQb3J0OiA4MCxcbiAgaW1hZ2U6IENvbnRhaW5lckltYWdlLmZyb21SZWdpc3RyeSgnbmF0aGFucGVjay9uYW1lJyksXG4gIGVudmlyb25tZW50OiB7XG4gICAgUE9SVDogJzgwJyxcbiAgfSxcbn0pKTtcbm5hbWVEZXNjcmlwdGlvbi5hZGQobmV3IEFwcE1lc2hFeHRlbnNpb24oeyBtZXNoIH0pKTtcbm5hbWVEZXNjcmlwdGlvbi5hZGQobmV3IEZpcmVMZW5zRXh0ZW5zaW9uKCkpO1xubmFtZURlc2NyaXB0aW9uLmFkZChuZXcgWFJheUV4dGVuc2lvbigpKTtcbm5hbWVEZXNjcmlwdGlvbi5hZGQobmV3IENsb3Vkd2F0Y2hBZ2VudEV4dGVuc2lvbigpKTtcbm5hbWVEZXNjcmlwdGlvbi5hZGQobmV3IFNjYWxlT25DcHVVdGlsaXphdGlvbih7XG4gIGluaXRpYWxUYXNrQ291bnQ6IDIsXG4gIG1pblRhc2tDb3VudDogMixcbn0pKTtcblxuY29uc3QgbmFtZVNlcnZpY2UgPSBuZXcgU2VydmljZShzdGFjaywgJ25hbWUnLCB7XG4gIGVudmlyb25tZW50OiBlbnZpcm9ubWVudCxcbiAgc2VydmljZURlc2NyaXB0aW9uOiBuYW1lRGVzY3JpcHRpb24sXG59KTtcblxuLyoqIEdyZWV0aW5nIHNlcnZpY2UgKi9cbmNvbnN0IGdyZWV0aW5nRGVzY3JpcHRpb24gPSBuZXcgU2VydmljZURlc2NyaXB0aW9uKCk7XG5ncmVldGluZ0Rlc2NyaXB0aW9uLmFkZChuZXcgQ29udGFpbmVyKHtcbiAgY3B1OiAxMDI0LFxuICBtZW1vcnlNaUI6IDIwNDgsXG4gIHRyYWZmaWNQb3J0OiA4MCxcbiAgaW1hZ2U6IENvbnRhaW5lckltYWdlLmZyb21SZWdpc3RyeSgnbmF0aGFucGVjay9ncmVldGluZycpLFxuICBlbnZpcm9ubWVudDoge1xuICAgIFBPUlQ6ICc4MCcsXG4gIH0sXG59KSk7XG5ncmVldGluZ0Rlc2NyaXB0aW9uLmFkZChuZXcgQXBwTWVzaEV4dGVuc2lvbih7IG1lc2ggfSkpO1xuZ3JlZXRpbmdEZXNjcmlwdGlvbi5hZGQobmV3IEZpcmVMZW5zRXh0ZW5zaW9uKCkpO1xuZ3JlZXRpbmdEZXNjcmlwdGlvbi5hZGQobmV3IFhSYXlFeHRlbnNpb24oKSk7XG5ncmVldGluZ0Rlc2NyaXB0aW9uLmFkZChuZXcgQ2xvdWR3YXRjaEFnZW50RXh0ZW5zaW9uKCkpO1xuZ3JlZXRpbmdEZXNjcmlwdGlvbi5hZGQobmV3IFNjYWxlT25DcHVVdGlsaXphdGlvbih7XG4gIGluaXRpYWxUYXNrQ291bnQ6IDIsXG4gIG1pblRhc2tDb3VudDogMixcbn0pKTtcblxuY29uc3QgZ3JlZXRpbmdTZXJ2aWNlID0gbmV3IFNlcnZpY2Uoc3RhY2ssICdncmVldGluZycsIHtcbiAgZW52aXJvbm1lbnQ6IGVudmlyb25tZW50LFxuICBzZXJ2aWNlRGVzY3JpcHRpb246IGdyZWV0aW5nRGVzY3JpcHRpb24sXG59KTtcblxuLyoqIEdyZWV0ZXIgc2VydmljZSAqL1xuY29uc3QgZ3JlZXRlckRlc2NyaXB0aW9uID0gbmV3IFNlcnZpY2VEZXNjcmlwdGlvbigpO1xuZ3JlZXRlckRlc2NyaXB0aW9uLmFkZChuZXcgQ29udGFpbmVyKHtcbiAgY3B1OiAxMDI0LFxuICBtZW1vcnlNaUI6IDIwNDgsXG4gIHRyYWZmaWNQb3J0OiA4MCxcbiAgaW1hZ2U6IENvbnRhaW5lckltYWdlLmZyb21SZWdpc3RyeSgnbmF0aGFucGVjay9ncmVldGVyJyksXG4gIGVudmlyb25tZW50OiB7XG4gICAgUE9SVDogJzgwJyxcbiAgICBHUkVFVElOR19VUkw6ICdodHRwOi8vZ3JlZXRpbmcucHJvZHVjdGlvbicsXG4gICAgTkFNRV9VUkw6ICdodHRwOi8vbmFtZS5wcm9kdWN0aW9uJyxcbiAgfSxcbn0pKTtcbmdyZWV0ZXJEZXNjcmlwdGlvbi5hZGQobmV3IEFwcE1lc2hFeHRlbnNpb24oeyBtZXNoIH0pKTtcbmdyZWV0ZXJEZXNjcmlwdGlvbi5hZGQobmV3IEZpcmVMZW5zRXh0ZW5zaW9uKCkpO1xuZ3JlZXRlckRlc2NyaXB0aW9uLmFkZChuZXcgWFJheUV4dGVuc2lvbigpKTtcbmdyZWV0ZXJEZXNjcmlwdGlvbi5hZGQobmV3IENsb3Vkd2F0Y2hBZ2VudEV4dGVuc2lvbigpKTtcbmdyZWV0ZXJEZXNjcmlwdGlvbi5hZGQobmV3IEh0dHBMb2FkQmFsYW5jZXJFeHRlbnNpb24oKSk7XG5ncmVldGVyRGVzY3JpcHRpb24uYWRkKG5ldyBTY2FsZU9uQ3B1VXRpbGl6YXRpb24oe1xuICBpbml0aWFsVGFza0NvdW50OiAyLFxuICBtaW5UYXNrQ291bnQ6IDIsXG59KSk7XG5cbmNvbnN0IGdyZWV0ZXJTZXJ2aWNlID0gbmV3IFNlcnZpY2Uoc3RhY2ssICdncmVldGVyJywge1xuICBlbnZpcm9ubWVudDogZW52aXJvbm1lbnQsXG4gIHNlcnZpY2VEZXNjcmlwdGlvbjogZ3JlZXRlckRlc2NyaXB0aW9uLFxufSk7XG5cbmdyZWV0ZXJTZXJ2aWNlLmNvbm5lY3RUbyhuYW1lU2VydmljZSk7XG5ncmVldGVyU2VydmljZS5jb25uZWN0VG8oZ3JlZXRpbmdTZXJ2aWNlKTtcblxuLyoqXG4gKiBFeHBlY3RhdGlvbnMgYXJlIHRoYXQgeW91IHNob3VsZCBzZWUgYW4gb3V0cHV0XG4gKiBvZiB0aGUgbG9hZCBiYWxhbmNlciBVUkwgZm9yIHRoZSBncmVldGVyIHNlcnZpY2UsIG1ha2VcbiAqIGEgcmVxdWVzdCB0byBpdCBhbmQgc2VlIGEgZ3JlZXRpbmcgcGhyYXNlIGNvbnN0cnVjdGVkIG91dFxuICogb2YgYSByYW5kb20gZ3JlZXRpbmcgYW5kIGEgcmFuZG9tIG5hbWUgZnJvbSB0aGUgdHdvIHVuZGVybHlpbmdcbiAqIHNlcnZpY2VzLiBUaGUgb3RoZXIgYWRkb25zIGVuYWJsZSB0cmFjaW5nIGFuZCBsb2dnaW5nIHdoaWNoIG11c3RcbiAqIGJlIHZlcmlmaWVkIHNlcGFyYXRlbHkuXG4gKi8iXX0=