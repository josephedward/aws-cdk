"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImportedEnvironment = exports.Environment = void 0;
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const constructs_1 = require("constructs");
const extension_interfaces_1 = require("./extensions/extension-interfaces");
/**
 * An environment into which to deploy a service. This environment
 * can either be instantiated with a pre-existing AWS VPC and ECS cluster,
 * or it can create its own VPC and cluster. By default, it will create
 * a cluster with Fargate capacity.
 */
class Environment extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.scope = scope;
        this.id = id;
        if (props && props.vpc) {
            this.vpc = props.vpc;
        }
        else {
            this.vpc = new ec2.Vpc(this.scope, `${this.id}-environment-vpc`);
        }
        if (props && props.cluster) {
            this.cluster = props.cluster;
        }
        else {
            this.cluster = new ecs.Cluster(this.scope, `${this.id}-environment-cluster`, { vpc: this.vpc });
        }
        if (props && props.capacityType) {
            this.capacityType = props.capacityType;
        }
        else {
            this.capacityType = extension_interfaces_1.EnvironmentCapacityType.FARGATE;
        }
    }
    /**
     * Import an existing environment from its attributes.
     */
    static fromEnvironmentAttributes(scope, id, attrs) {
        return new ImportedEnvironment(scope, id, attrs);
    }
    /**
     * Add a default cloudmap namespace to the environment's cluster.
     */
    addDefaultCloudMapNamespace(options) {
        this.cluster.addDefaultCloudMapNamespace(options);
    }
}
exports.Environment = Environment;
class ImportedEnvironment extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.id = id;
        this.capacityType = props.capacityType;
        this.cluster = props.cluster;
        this.vpc = props.cluster.vpc;
    }
    /**
     * Adding a default cloudmap namespace to the cluster will throw an error, as we don't
     * own it.
     */
    addDefaultCloudMapNamespace(_options) {
        throw new Error('the cluster environment is immutable when imported');
    }
}
exports.ImportedEnvironment = ImportedEnvironment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52aXJvbm1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJlbnZpcm9ubWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBQ3hDLDJDQUF1QztBQUN2Qyw0RUFBNEU7QUEyRDVFOzs7OztHQUtHO0FBQ0gsTUFBYSxXQUFZLFNBQVEsc0JBQVM7SUE4QnhDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBd0I7UUFDaEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUViLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDdEIsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO1NBQ3RCO2FBQU07WUFDTCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztTQUNsRTtRQUVELElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDMUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1NBQzlCO2FBQU07WUFDTCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsc0JBQXNCLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDakc7UUFFRCxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFO1lBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQztTQUN4QzthQUFNO1lBQ0wsSUFBSSxDQUFDLFlBQVksR0FBRyw4Q0FBdUIsQ0FBQyxPQUFPLENBQUM7U0FDckQ7SUFDSCxDQUFDO0lBcEREOztPQUVHO0lBQ0ksTUFBTSxDQUFDLHlCQUF5QixDQUFDLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTRCO1FBQ2hHLE9BQU8sSUFBSSxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFpREQ7O09BRUc7SUFDSCwyQkFBMkIsQ0FBQyxPQUFxQztRQUMvRCxJQUFJLENBQUMsT0FBTyxDQUFDLDJCQUEyQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDRjtBQTdERCxrQ0E2REM7QUFjRCxNQUFhLG1CQUFvQixTQUFRLHNCQUFTO0lBTWhELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBNEI7UUFDcEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUN2QyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDN0IsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUMvQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsMkJBQTJCLENBQUMsUUFBc0M7UUFDaEUsTUFBTSxJQUFJLEtBQUssQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7Q0FDRjtBQXRCRCxrREFzQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBlY3MgZnJvbSAnQGF3cy1jZGsvYXdzLWVjcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IEVudmlyb25tZW50Q2FwYWNpdHlUeXBlIH0gZnJvbSAnLi9leHRlbnNpb25zL2V4dGVuc2lvbi1pbnRlcmZhY2VzJztcblxuLyoqXG4gKiBTZXR0aW5ncyBmb3IgdGhlIGVudmlyb25tZW50IHdoZXJlIHlvdSB3YW50IHRvIGRlcGxveSB5b3VyIHNlcnZpY2VzLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEVudmlyb25tZW50UHJvcHMge1xuICAvKipcbiAgICogVGhlIFZQQyB1c2VkIGJ5IHRoZSBzZXJ2aWNlIGZvciBuZXR3b3JraW5nLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIENyZWF0ZSBhIG5ldyBWUENcbiAgICovXG4gIHJlYWRvbmx5IHZwYz86IGVjMi5JVnBjLFxuXG4gIC8qKlxuICAgKiBUaGUgRUNTIGNsdXN0ZXIgd2hpY2ggcHJvdmlkZXMgY29tcHV0ZSBjYXBhY2l0eSB0byB0aGlzIHNlcnZpY2UuXG4gICAqXG4gICAqIFtkaXNhYmxlLWF3c2xpbnQ6cmVmLXZpYS1pbnRlcmZhY2VdXG4gICAqIEBkZWZhdWx0IC0gQ3JlYXRlIGEgbmV3IGNsdXN0ZXJcbiAgICovXG4gIHJlYWRvbmx5IGNsdXN0ZXI/OiBlY3MuQ2x1c3RlclxuXG4gIC8qKlxuICAgKiBUaGUgdHlwZSBvZiBjYXBhY2l0eSB0byB1c2UgZm9yIHRoaXMgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRW52aXJvbm1lbnRDYXBhY2l0eVR5cGUuRkFSR0FURVxuICAgKi9cbiAgcmVhZG9ubHkgY2FwYWNpdHlUeXBlPzogRW52aXJvbm1lbnRDYXBhY2l0eVR5cGVcbn1cblxuLyoqXG4gKiBBbiBlbnZpcm9ubWVudCBpbnRvIHdoaWNoIHRvIGRlcGxveSBhIHNlcnZpY2UuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUVudmlyb25tZW50IHtcbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoaXMgZW52aXJvbm1lbnQuXG4gICAqL1xuICByZWFkb25seSBpZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIGludG8gd2hpY2ggZW52aXJvbm1lbnQgc2VydmljZXMgc2hvdWxkIGJlIHBsYWNlZC5cbiAgICovXG4gIHJlYWRvbmx5IHZwYzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFRoZSBjbHVzdGVyIHRoYXQgaXMgcHJvdmlkaW5nIGNhcGFjaXR5IGZvciB0aGlzIHNlcnZpY2UuXG4gICAqL1xuICByZWFkb25seSBjbHVzdGVyOiBlY3MuSUNsdXN0ZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBjYXBhY2l0eSB0eXBlIHVzZWQgYnkgdGhlIHNlcnZpY2UncyBjbHVzdGVyLlxuICAgKi9cbiAgcmVhZG9ubHkgY2FwYWNpdHlUeXBlOiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZTtcblxuICAvKipcbiAgICogQWRkIGEgZGVmYXVsdCBjbG91ZG1hcCBuYW1lc3BhY2UgdG8gdGhlIGVudmlyb25tZW50J3MgY2x1c3Rlci5cbiAgICovXG4gIGFkZERlZmF1bHRDbG91ZE1hcE5hbWVzcGFjZShvcHRpb25zOiBlY3MuQ2xvdWRNYXBOYW1lc3BhY2VPcHRpb25zKTogdm9pZDtcbn1cblxuLyoqXG4gKiBBbiBlbnZpcm9ubWVudCBpbnRvIHdoaWNoIHRvIGRlcGxveSBhIHNlcnZpY2UuIFRoaXMgZW52aXJvbm1lbnRcbiAqIGNhbiBlaXRoZXIgYmUgaW5zdGFudGlhdGVkIHdpdGggYSBwcmUtZXhpc3RpbmcgQVdTIFZQQyBhbmQgRUNTIGNsdXN0ZXIsXG4gKiBvciBpdCBjYW4gY3JlYXRlIGl0cyBvd24gVlBDIGFuZCBjbHVzdGVyLiBCeSBkZWZhdWx0LCBpdCB3aWxsIGNyZWF0ZVxuICogYSBjbHVzdGVyIHdpdGggRmFyZ2F0ZSBjYXBhY2l0eS5cbiAqL1xuZXhwb3J0IGNsYXNzIEVudmlyb25tZW50IGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgSUVudmlyb25tZW50IHtcbiAgLyoqXG4gICAqIEltcG9ydCBhbiBleGlzdGluZyBlbnZpcm9ubWVudCBmcm9tIGl0cyBhdHRyaWJ1dGVzLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tRW52aXJvbm1lbnRBdHRyaWJ1dGVzKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIGF0dHJzOiBFbnZpcm9ubWVudEF0dHJpYnV0ZXMpOiBJRW52aXJvbm1lbnQge1xuICAgIHJldHVybiBuZXcgSW1wb3J0ZWRFbnZpcm9ubWVudChzY29wZSwgaWQsIGF0dHJzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGlzIGVudmlyb25tZW50LlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgd2hlcmUgZW52aXJvbm1lbnQgc2VydmljZXMgc2hvdWxkIGJlIHBsYWNlZC5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB2cGM6IGVjMi5JVnBjO1xuXG4gIC8qKlxuICAgKiBUaGUgY2x1c3RlciB0aGF0IGlzIHByb3ZpZGluZyBjYXBhY2l0eSBmb3IgdGhpcyBzZXJ2aWNlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNsdXN0ZXI6IGVjcy5DbHVzdGVyO1xuXG4gIC8qKlxuICAgKiBUaGUgY2FwYWNpdHkgdHlwZSB1c2VkIGJ5IHRoZSBzZXJ2aWNlJ3MgY2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjYXBhY2l0eVR5cGU6IEVudmlyb25tZW50Q2FwYWNpdHlUeXBlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgc2NvcGU6IENvbnN0cnVjdDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEVudmlyb25tZW50UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5zY29wZSA9IHNjb3BlO1xuICAgIHRoaXMuaWQgPSBpZDtcblxuICAgIGlmIChwcm9wcyAmJiBwcm9wcy52cGMpIHtcbiAgICAgIHRoaXMudnBjID0gcHJvcHMudnBjO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnZwYyA9IG5ldyBlYzIuVnBjKHRoaXMuc2NvcGUsIGAke3RoaXMuaWR9LWVudmlyb25tZW50LXZwY2ApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcyAmJiBwcm9wcy5jbHVzdGVyKSB7XG4gICAgICB0aGlzLmNsdXN0ZXIgPSBwcm9wcy5jbHVzdGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNsdXN0ZXIgPSBuZXcgZWNzLkNsdXN0ZXIodGhpcy5zY29wZSwgYCR7dGhpcy5pZH0tZW52aXJvbm1lbnQtY2x1c3RlcmAsIHsgdnBjOiB0aGlzLnZwYyB9KTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMgJiYgcHJvcHMuY2FwYWNpdHlUeXBlKSB7XG4gICAgICB0aGlzLmNhcGFjaXR5VHlwZSA9IHByb3BzLmNhcGFjaXR5VHlwZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jYXBhY2l0eVR5cGUgPSBFbnZpcm9ubWVudENhcGFjaXR5VHlwZS5GQVJHQVRFO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBkZWZhdWx0IGNsb3VkbWFwIG5hbWVzcGFjZSB0byB0aGUgZW52aXJvbm1lbnQncyBjbHVzdGVyLlxuICAgKi9cbiAgYWRkRGVmYXVsdENsb3VkTWFwTmFtZXNwYWNlKG9wdGlvbnM6IGVjcy5DbG91ZE1hcE5hbWVzcGFjZU9wdGlvbnMpIHtcbiAgICB0aGlzLmNsdXN0ZXIuYWRkRGVmYXVsdENsb3VkTWFwTmFtZXNwYWNlKG9wdGlvbnMpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW52aXJvbm1lbnRBdHRyaWJ1dGVzIHtcbiAgLyoqXG4gICAqIFRoZSBjYXBhY2l0eSB0eXBlIHVzZWQgYnkgdGhlIHNlcnZpY2UncyBjbHVzdGVyLlxuICAgKi9cbiAgY2FwYWNpdHlUeXBlOiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZTtcblxuICAvKipcbiAgICogVGhlIGNsdXN0ZXIgdGhhdCBpcyBwcm92aWRpbmcgY2FwYWNpdHkgZm9yIHRoaXMgc2VydmljZS5cbiAgICovXG4gIGNsdXN0ZXI6IGVjcy5JQ2x1c3Rlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEltcG9ydGVkRW52aXJvbm1lbnQgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBJRW52aXJvbm1lbnQge1xuICBwdWJsaWMgcmVhZG9ubHkgY2FwYWNpdHlUeXBlOiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZTtcbiAgcHVibGljIHJlYWRvbmx5IGNsdXN0ZXI6IGVjcy5JQ2x1c3RlcjtcbiAgcHVibGljIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSB2cGM6IGVjMi5JVnBjO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFbnZpcm9ubWVudEF0dHJpYnV0ZXMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuY2FwYWNpdHlUeXBlID0gcHJvcHMuY2FwYWNpdHlUeXBlO1xuICAgIHRoaXMuY2x1c3RlciA9IHByb3BzLmNsdXN0ZXI7XG4gICAgdGhpcy52cGMgPSBwcm9wcy5jbHVzdGVyLnZwYztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRpbmcgYSBkZWZhdWx0IGNsb3VkbWFwIG5hbWVzcGFjZSB0byB0aGUgY2x1c3RlciB3aWxsIHRocm93IGFuIGVycm9yLCBhcyB3ZSBkb24ndFxuICAgKiBvd24gaXQuXG4gICAqL1xuICBhZGREZWZhdWx0Q2xvdWRNYXBOYW1lc3BhY2UoX29wdGlvbnM6IGVjcy5DbG91ZE1hcE5hbWVzcGFjZU9wdGlvbnMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RoZSBjbHVzdGVyIGVudmlyb25tZW50IGlzIGltbXV0YWJsZSB3aGVuIGltcG9ydGVkJyk7XG4gIH1cbn1cbiJdfQ==