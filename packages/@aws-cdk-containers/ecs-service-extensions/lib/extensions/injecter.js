"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InjecterExtension = exports.InjectableTopic = void 0;
const extension_interfaces_1 = require("./extension-interfaces");
/**
 * The `InjectableTopic` class represents SNS Topic resource that can be published events to by the parent service.
 */
class InjectableTopic {
    constructor(props) {
        this.topic = props.topic;
    }
    grant(taskDefinition) {
        this.topic.grantPublish(taskDefinition.taskRole);
    }
    environmentVariables() {
        let environment = {};
        environment[`${this.topic.node.id.toUpperCase()}_TOPIC_ARN`] = this.topic.topicArn;
        return environment;
    }
}
exports.InjectableTopic = InjectableTopic;
/**
 * This hook modifies the application container's environment to
 * add the injectable resource environment variables.
 */
class InjecterExtensionMutatingHook extends extension_interfaces_1.ContainerMutatingHook {
    constructor(props) {
        super();
        this.environment = props.environment;
    }
    mutateContainerDefinition(props) {
        return {
            ...props,
            environment: { ...(props.environment || {}), ...this.environment },
        };
    }
}
/**
 * This extension accepts a list of `Injectable` resources that the parent service can publish events or write data to.
 * It sets up the corresponding permissions for the task role of the parent service.
 */
class InjecterExtension extends extension_interfaces_1.ServiceExtension {
    constructor(props) {
        super('injecter');
        this.environment = {};
        this.props = props;
    }
    // @ts-ignore - Ignore unused params that are required for abstract class extend
    prehook(service, scope) {
        this.parentService = service;
        for (const injectable of this.props.injectables) {
            for (const [key, val] of Object.entries(injectable.environmentVariables())) {
                this.environment[key] = val;
            }
        }
    }
    /**
     * Add hooks to the main application extension so that it is modified to
     * add the injectable resource environment variables to the container environment.
     */
    addHooks() {
        const container = this.parentService.serviceDescription.get('service-container');
        if (!container) {
            throw new Error('Injecter Extension requires an application extension');
        }
        container.addContainerMutatingHook(new InjecterExtensionMutatingHook({
            environment: this.environment,
        }));
    }
    /**
     * After the task definition has been created, this hook grants the required permissions to the task role for the
     * parent service.
     *
     * @param taskDefinition The created task definition
     */
    useTaskDefinition(taskDefinition) {
        for (const injectable of this.props.injectables) {
            if (injectable.grant !== undefined) {
                injectable.grant(taskDefinition);
            }
        }
    }
}
exports.InjecterExtension = InjecterExtension;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmplY3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFLQSxpRUFBaUY7QUEwQmpGOztHQUVHO0FBRUgsTUFBYSxlQUFlO0lBRzFCLFlBQVksS0FBMkI7UUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO0lBQzNCLENBQUM7SUFFTSxLQUFLLENBQUMsY0FBa0M7UUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFTSxvQkFBb0I7UUFDekIsSUFBSSxXQUFXLEdBQThCLEVBQUUsQ0FBQztRQUNoRCxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQ25GLE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7Q0FDRjtBQWhCRCwwQ0FnQkM7QUF1QkQ7OztHQUdHO0FBQ0gsTUFBTSw2QkFBOEIsU0FBUSw0Q0FBcUI7SUFHL0QsWUFBWSxLQUE2QjtRQUN2QyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztJQUN2QyxDQUFDO0lBRU0seUJBQXlCLENBQUMsS0FBcUM7UUFDcEUsT0FBTztZQUNMLEdBQUcsS0FBSztZQUVSLFdBQVcsRUFBRSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRTtTQUNqQyxDQUFDO0lBQ3RDLENBQUM7Q0FDRjtBQUVEOzs7R0FHRztBQUNILE1BQWEsaUJBQWtCLFNBQVEsdUNBQWdCO0lBS3JELFlBQVksS0FBNkI7UUFDdkMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBSFosZ0JBQVcsR0FBOEIsRUFBRSxDQUFDO1FBS2xELElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxnRkFBZ0Y7SUFDekUsT0FBTyxDQUFDLE9BQWdCLEVBQUUsS0FBZ0I7UUFDL0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUM7UUFFN0IsS0FBSyxNQUFNLFVBQVUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUMvQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxFQUFFO2dCQUMxRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQzthQUM3QjtTQUNGO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNJLFFBQVE7UUFDYixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBYyxDQUFDO1FBRTlGLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLHNEQUFzRCxDQUFDLENBQUM7U0FDekU7UUFFRCxTQUFTLENBQUMsd0JBQXdCLENBQUMsSUFBSSw2QkFBNkIsQ0FBQztZQUNuRSxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7U0FDOUIsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxpQkFBaUIsQ0FBQyxjQUFrQztRQUN6RCxLQUFLLE1BQU0sVUFBVSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQy9DLElBQUssVUFBOEIsQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO2dCQUN0RCxVQUE4QixDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUN2RDtTQUNGO0lBQ0gsQ0FBQztDQUNGO0FBbkRELDhDQW1EQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGVjcyBmcm9tICdAYXdzLWNkay9hd3MtZWNzJztcbmltcG9ydCAqIGFzIHNucyBmcm9tICdAYXdzLWNkay9hd3Mtc25zJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UnO1xuaW1wb3J0IHsgQ29udGFpbmVyIH0gZnJvbSAnLi9jb250YWluZXInO1xuaW1wb3J0IHsgQ29udGFpbmVyTXV0YXRpbmdIb29rLCBTZXJ2aWNlRXh0ZW5zaW9uIH0gZnJvbSAnLi9leHRlbnNpb24taW50ZXJmYWNlcyc7XG5cbi8qKlxuICogQW4gaW50ZXJmYWNlIHRoYXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBieSBhbGwgdGhlIHJlc291cmNlcyB0aGF0IGNhbiBiZSBwdWJsaXNoZWQgZXZlbnRzIG9yIHdyaXR0ZW4gZGF0YSB0by5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmplY3RhYmxlIHtcbiAgZW52aXJvbm1lbnRWYXJpYWJsZXMoKTogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbn1cblxuLyoqXG4gKiBBbiBpbnRlcmZhY2UgdGhhdCB3aWxsIGJlIGltcGxlbWVudGVkIGJ5IGFsbCB0aGUgaW5qZWN0YWJsZSByZXNvdXJjZXMgdGhhdCBuZWVkIHRvIGdyYW50IHBlcm1pc3Npb25zIHRvIHRoZSB0YXNrIHJvbGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR3JhbnRJbmplY3RhYmxlIGV4dGVuZHMgSW5qZWN0YWJsZSB7XG4gIGdyYW50KHRhc2tEZWZpbml0aW9uOiBlY3MuVGFza0RlZmluaXRpb24pOiB2b2lkO1xufVxuXG4vKipcbiAqIFRoZSBzZXR0aW5ncyBmb3IgdGhlIGBJbmplY3RhYmxlVG9waWNgIGNsYXNzLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEluamVjdGFibGVUb3BpY1Byb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBTTlMgVG9waWMgdG8gcHVibGlzaCBldmVudHMgdG8uXG4gICAqL1xuICByZWFkb25seSB0b3BpYzogc25zLklUb3BpYztcbn1cblxuLyoqXG4gKiBUaGUgYEluamVjdGFibGVUb3BpY2AgY2xhc3MgcmVwcmVzZW50cyBTTlMgVG9waWMgcmVzb3VyY2UgdGhhdCBjYW4gYmUgcHVibGlzaGVkIGV2ZW50cyB0byBieSB0aGUgcGFyZW50IHNlcnZpY2UuXG4gKi9cblxuZXhwb3J0IGNsYXNzIEluamVjdGFibGVUb3BpYyBpbXBsZW1lbnRzIEdyYW50SW5qZWN0YWJsZSB7XG4gIHB1YmxpYyByZWFkb25seSB0b3BpYzogc25zLklUb3BpYztcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogSW5qZWN0YWJsZVRvcGljUHJvcHMpIHtcbiAgICB0aGlzLnRvcGljID0gcHJvcHMudG9waWM7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnQodGFza0RlZmluaXRpb246IGVjcy5UYXNrRGVmaW5pdGlvbikge1xuICAgIHRoaXMudG9waWMuZ3JhbnRQdWJsaXNoKHRhc2tEZWZpbml0aW9uLnRhc2tSb2xlKTtcbiAgfVxuXG4gIHB1YmxpYyBlbnZpcm9ubWVudFZhcmlhYmxlcygpOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9IHtcbiAgICBsZXQgZW52aXJvbm1lbnQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcbiAgICBlbnZpcm9ubWVudFtgJHt0aGlzLnRvcGljLm5vZGUuaWQudG9VcHBlckNhc2UoKX1fVE9QSUNfQVJOYF0gPSB0aGlzLnRvcGljLnRvcGljQXJuO1xuICAgIHJldHVybiBlbnZpcm9ubWVudDtcbiAgfVxufVxuXG4vKipcbiAqIFRoZSBzZXR0aW5ncyBmb3IgdGhlIEluamVjdGVyIGV4dGVuc2lvbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmplY3RlckV4dGVuc2lvblByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBsaXN0IG9mIGluamVjdGFibGUgcmVzb3VyY2VzIGZvciB0aGlzIHNlcnZpY2UuXG4gICAqL1xuICByZWFkb25seSBpbmplY3RhYmxlczogSW5qZWN0YWJsZVtdO1xufVxuXG4vKipcbiAqIFNldHRpbmdzIGZvciB0aGUgaG9vayB3aGljaCBtdXRhdGVzIHRoZSBhcHBsaWNhdGlvbiBjb250YWluZXJcbiAqIHRvIGFkZCB0aGUgaW5qZWN0YWJsZSByZXNvdXJjZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuXG4gKi9cbmludGVyZmFjZSBDb250YWluZXJNdXRhdGluZ1Byb3BzIHtcbiAgLyoqXG4gICAqIFRoZSByZXNvdXJjZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdG8gYmUgYWRkZWQgdG8gdGhlIGNvbnRhaW5lciBlbnZpcm9ubWVudC5cbiAgICovXG4gIHJlYWRvbmx5IGVudmlyb25tZW50OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xufVxuXG4vKipcbiAqIFRoaXMgaG9vayBtb2RpZmllcyB0aGUgYXBwbGljYXRpb24gY29udGFpbmVyJ3MgZW52aXJvbm1lbnQgdG9cbiAqIGFkZCB0aGUgaW5qZWN0YWJsZSByZXNvdXJjZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuXG4gKi9cbmNsYXNzIEluamVjdGVyRXh0ZW5zaW9uTXV0YXRpbmdIb29rIGV4dGVuZHMgQ29udGFpbmVyTXV0YXRpbmdIb29rIHtcbiAgcHJpdmF0ZSBlbnZpcm9ubWVudDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogQ29udGFpbmVyTXV0YXRpbmdQcm9wcykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5lbnZpcm9ubWVudCA9IHByb3BzLmVudmlyb25tZW50O1xuICB9XG5cbiAgcHVibGljIG11dGF0ZUNvbnRhaW5lckRlZmluaXRpb24ocHJvcHM6IGVjcy5Db250YWluZXJEZWZpbml0aW9uT3B0aW9ucyk6IGVjcy5Db250YWluZXJEZWZpbml0aW9uT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnByb3BzLFxuXG4gICAgICBlbnZpcm9ubWVudDogeyAuLi4ocHJvcHMuZW52aXJvbm1lbnQgfHwge30pLCAuLi50aGlzLmVudmlyb25tZW50IH0sXG4gICAgfSBhcyBlY3MuQ29udGFpbmVyRGVmaW5pdGlvbk9wdGlvbnM7XG4gIH1cbn1cblxuLyoqXG4gKiBUaGlzIGV4dGVuc2lvbiBhY2NlcHRzIGEgbGlzdCBvZiBgSW5qZWN0YWJsZWAgcmVzb3VyY2VzIHRoYXQgdGhlIHBhcmVudCBzZXJ2aWNlIGNhbiBwdWJsaXNoIGV2ZW50cyBvciB3cml0ZSBkYXRhIHRvLlxuICogSXQgc2V0cyB1cCB0aGUgY29ycmVzcG9uZGluZyBwZXJtaXNzaW9ucyBmb3IgdGhlIHRhc2sgcm9sZSBvZiB0aGUgcGFyZW50IHNlcnZpY2UuXG4gKi9cbmV4cG9ydCBjbGFzcyBJbmplY3RlckV4dGVuc2lvbiBleHRlbmRzIFNlcnZpY2VFeHRlbnNpb24ge1xuICBwcml2YXRlIHByb3BzOiBJbmplY3RlckV4dGVuc2lvblByb3BzO1xuXG4gIHByaXZhdGUgZW52aXJvbm1lbnQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogSW5qZWN0ZXJFeHRlbnNpb25Qcm9wcykge1xuICAgIHN1cGVyKCdpbmplY3RlcicpO1xuXG4gICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuICB9XG5cbiAgLy8gQHRzLWlnbm9yZSAtIElnbm9yZSB1bnVzZWQgcGFyYW1zIHRoYXQgYXJlIHJlcXVpcmVkIGZvciBhYnN0cmFjdCBjbGFzcyBleHRlbmRcbiAgcHVibGljIHByZWhvb2soc2VydmljZTogU2VydmljZSwgc2NvcGU6IENvbnN0cnVjdCkge1xuICAgIHRoaXMucGFyZW50U2VydmljZSA9IHNlcnZpY2U7XG5cbiAgICBmb3IgKGNvbnN0IGluamVjdGFibGUgb2YgdGhpcy5wcm9wcy5pbmplY3RhYmxlcykge1xuICAgICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKGluamVjdGFibGUuZW52aXJvbm1lbnRWYXJpYWJsZXMoKSkpIHtcbiAgICAgICAgdGhpcy5lbnZpcm9ubWVudFtrZXldID0gdmFsO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgaG9va3MgdG8gdGhlIG1haW4gYXBwbGljYXRpb24gZXh0ZW5zaW9uIHNvIHRoYXQgaXQgaXMgbW9kaWZpZWQgdG9cbiAgICogYWRkIHRoZSBpbmplY3RhYmxlIHJlc291cmNlIGVudmlyb25tZW50IHZhcmlhYmxlcyB0byB0aGUgY29udGFpbmVyIGVudmlyb25tZW50LlxuICAgKi9cbiAgcHVibGljIGFkZEhvb2tzKCkge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMucGFyZW50U2VydmljZS5zZXJ2aWNlRGVzY3JpcHRpb24uZ2V0KCdzZXJ2aWNlLWNvbnRhaW5lcicpIGFzIENvbnRhaW5lcjtcblxuICAgIGlmICghY29udGFpbmVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0luamVjdGVyIEV4dGVuc2lvbiByZXF1aXJlcyBhbiBhcHBsaWNhdGlvbiBleHRlbnNpb24nKTtcbiAgICB9XG5cbiAgICBjb250YWluZXIuYWRkQ29udGFpbmVyTXV0YXRpbmdIb29rKG5ldyBJbmplY3RlckV4dGVuc2lvbk11dGF0aW5nSG9vayh7XG4gICAgICBlbnZpcm9ubWVudDogdGhpcy5lbnZpcm9ubWVudCxcbiAgICB9KSk7XG4gIH1cblxuICAvKipcbiAgICogQWZ0ZXIgdGhlIHRhc2sgZGVmaW5pdGlvbiBoYXMgYmVlbiBjcmVhdGVkLCB0aGlzIGhvb2sgZ3JhbnRzIHRoZSByZXF1aXJlZCBwZXJtaXNzaW9ucyB0byB0aGUgdGFzayByb2xlIGZvciB0aGVcbiAgICogcGFyZW50IHNlcnZpY2UuXG4gICAqXG4gICAqIEBwYXJhbSB0YXNrRGVmaW5pdGlvbiBUaGUgY3JlYXRlZCB0YXNrIGRlZmluaXRpb25cbiAgICovXG4gIHB1YmxpYyB1c2VUYXNrRGVmaW5pdGlvbih0YXNrRGVmaW5pdGlvbjogZWNzLlRhc2tEZWZpbml0aW9uKSB7XG4gICAgZm9yIChjb25zdCBpbmplY3RhYmxlIG9mIHRoaXMucHJvcHMuaW5qZWN0YWJsZXMpIHtcbiAgICAgIGlmICgoaW5qZWN0YWJsZSBhcyBHcmFudEluamVjdGFibGUpLmdyYW50ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgKGluamVjdGFibGUgYXMgR3JhbnRJbmplY3RhYmxlKS5ncmFudCh0YXNrRGVmaW5pdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=